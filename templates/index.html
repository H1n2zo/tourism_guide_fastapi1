<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourism Guide System - Explore Ormoc City</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
    
    <!-- CDN Links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Custom CSS Files -->
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/home.css">
    <link rel="stylesheet" href="/static/css/routes.css">
    <link rel="stylesheet" href="/static/css/map.css">
</head>
<body>
    <button id="backToTop" title="Back to top">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Navbar -->
    {% include 'components/navbar.html' %}

    <!-- Hero Section -->
    <section class="hero-section" id="home" style="margin-top: -76px; padding-top: 156px;">
        <div class="container text-center">
            <h1 class="display-3 fw-bold mb-3">Discover Amazing Places</h1>
            <p class="lead mb-4">Explore tourist destinations, find routes, and plan your journey</p>
            <a href="#destinations" class="btn btn-light btn-lg"><i class="fas fa-compass"></i> Start Exploring</a>
            
            <div class="stats-row">
                <div class="stat-item">
                    <h3>{{ total_destinations }}</h3>
                    <p>Destinations</p>
                </div>
                <div class="stat-item">
                    <h3>{{ total_reviews }}</h3>
                    <p>Reviews</p>
                </div>
                <div class="stat-item">
                    <h3>{{ total_categories }}</h3>
                    <p>Categories</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Search and Filter Section -->
    <div class="container">
        <div class="search-box">
            <form method="GET" class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" name="search" 
                               placeholder="Search destinations..." value="{{ search }}">
                    </div>
                </div>
                <div class="col-md-4">
                    <select class="form-select" name="category">
                        <option value="0">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if category_filter == cat.id %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter"></i> Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Destinations Grid -->
    <div class="container mt-5" id="destinations">
        <h2 class="mb-4"><i class="fas fa-map-pin"></i> Featured Destinations</h2>
        <div class="row g-4">
            {% if destinations %}
                {% for dest in destinations %}
                <div class="col-md-4">
                    <div class="card destination-card">
                        <div class="position-relative">
                            {% if dest.image_path %}
                            <img src="{{ UPLOAD_URL }}{{ dest.image_path }}" class="card-img-top" alt="{{ dest.name }}">
                            {% else %}
                            <img src="https://via.placeholder.com/400x400?text={{ dest.name }}" class="card-img-top" alt="{{ dest.name }}">
                            {% endif %}
                            <span class="category-badge">
                                <i class="fas {{ dest.icon }}"></i> {{ dest.category_name }}
                            </span>
                        </div>
                        <div class="card-body px-1">
                            <h5 class="card-title">{{ dest.name }}</h5>
                            <p class="card-text">{{ dest.description[:100] }}...</p>
                            <div class="mb-2">
                                {% if dest.review_count > 0 and dest.avg_rating > 0 %}
                                    <div class="rating">
                                        {% for i in range(5) %}
                                            {% if i < dest.avg_rating|round|int %}
                                            <i class="fas fa-star"></i>
                                            {% else %}
                                            <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <small class="rating-text">
                                        {{ dest.avg_rating }} / 5 
                                        ({{ dest.review_count }} review{% if dest.review_count != 1 %}s{% endif %})
                                    </small>
                                {% else %}
                                    <div class="not-rated">
                                        <i class="far fa-star"></i> Not rated yet
                                    </div>
                                {% endif %}
                            </div>
                            <a href="/destination/{{ dest.id }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-info-circle"></i> View Details
                            </a>
                            <button class="btn btn-outline-primary btn-sm" onclick="showOnMap({{ dest.latitude }}, {{ dest.longitude }}, '{{ dest.name }}')">
                                <i class="fas fa-map-marker-alt"></i> Show on Map
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No destinations found</h3>
                        <p class="text-muted">Try adjusting your search or filter criteria</p>
                        <a href="/" class="btn btn-primary">Clear Filters</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Transportation Routes Section -->
    <div class="container mt-5" id="routes">
        <h2 class="mb-4"><i class="fas fa-route"></i> Transportation Routes & Fares</h2>
        
        <div class="route-search-box">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label"><i class="fas fa-map-marker-alt"></i> Select Destination</label>
                    <select class="form-select" id="destinationFilter" onchange="filterRoutes()">
                        <option value="">All Destinations</option>
                        {% for dest in all_destinations %}
                        <option value="{{ dest.id }}">{{ dest.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label"><i class="fas fa-bus"></i> Transport Mode</label>
                    <select class="form-select" id="transportFilter" onchange="filterRoutes()">
                        <option value="">All Transport</option>
                        <option value="jeepney">Jeepney</option>
                        <option value="taxi">Taxi</option>
                        <option value="bus">Bus</option>
                        <option value="van">Van</option>
                        <option value="tricycle">Tricycle</option>
                        <option value="walking">Walking</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-redo"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <div id="routesList">
            <div class="no-routes">
                <i class="fas fa-info-circle fa-3x mb-3"></i>
                <p>Loading available routes...</p>
            </div>
        </div>
    </div>

    <!-- Map Section -->
    <div class="container mt-4" id="mapI">
        <h2 class="mb-4"><i class="fas fa-map"></i> Interactive Map</h2>
        <div id="map"></div>
    </div>

    <!-- Footer -->
    {% include 'components/footer.html' %}

    <!-- Bootstrap & Leaflet CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- FIXED: Pass backend data to JavaScript with proper escaping -->
    <script>
        // Safely pass destinations data from backend
        var destinationsData = {{ destinations|tojson|safe }};
        window.destinations = [
            {% for dest in destinations %}
            {
                id: {{ dest.id }},
                name: {{ dest.name|tojson|safe }},
                description: {{ (dest.description[:120] if dest.description else '')|tojson|safe }},
                latitude: {{ dest.latitude if dest.latitude else 'null' }},
                longitude: {{ dest.longitude if dest.longitude else 'null' }},
                image_path: {{ dest.image_path|tojson|safe }},
                category_name: {{ dest.category_name|tojson|safe }},
                icon: {{ dest.icon|tojson|safe }},
                review_count: {{ dest.review_count or 0 }},
                avg_rating: {{ dest.avg_rating or 0 }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        window.UPLOAD_URL = {{ UPLOAD_URL|tojson|safe }};
    </script>
    
    <!-- Custom JavaScript Files -->
    <script src="/static/js/map.js"></script>
    <script src="/static/js/routes.js"></script>
    <script src="/static/js/main.js"></script>

</body>
</html>